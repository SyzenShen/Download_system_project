<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶å¤¹åˆ›å»ºä½ç½®æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.error {
            background: #dc3545;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-steps {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .test-steps ol {
            margin: 0;
            padding-left: 20px;
        }
        .test-steps li {
            margin: 5px 0;
        }
        .folder-tree {
            font-family: monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-line;
        }
        .api-result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ“ æ–‡ä»¶å¤¹åˆ›å»ºä½ç½®æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ¯ æµ‹è¯•ç›®æ ‡</h2>
        <p>éªŒè¯åœ¨æ–‡ä»¶å¤¹å†…åˆ›å»ºæ–°æ–‡ä»¶å¤¹æ—¶ï¼Œæ–°æ–‡ä»¶å¤¹æ˜¯å¦æ­£ç¡®åˆ›å»ºåœ¨å½“å‰æ–‡ä»¶å¤¹å†…ï¼Œè€Œä¸æ˜¯æ ¹ç›®å½•ã€‚</p>
        
        <div class="test-steps">
            <h3>ä¿®å¤å†…å®¹</h3>
            <ul>
                <li>å‰ç«¯å‘é€çš„å­—æ®µåä» <code>parent_folder</code> æ”¹ä¸º <code>parent</code></li>
                <li>åŒ¹é…åç«¯ FolderCreateSerializer æœŸæœ›çš„å­—æ®µå</li>
            </ul>
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•</h2>
        <button class="test-button" onclick="runFullTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <button class="test-button" onclick="clearTestData()">ğŸ—‘ï¸ æ¸…ç†æµ‹è¯•æ•°æ®</button>
        <div id="test-status"></div>
        
        <h3>æµ‹è¯•æ­¥éª¤ï¼š</h3>
        <div class="test-steps">
            <ol>
                <li>åˆ›å»ºä¸»æµ‹è¯•æ–‡ä»¶å¤¹ "ä½ç½®æµ‹è¯•ä¸»æ–‡ä»¶å¤¹"</li>
                <li>è¿›å…¥è¯¥æ–‡ä»¶å¤¹</li>
                <li>åœ¨è¯¥æ–‡ä»¶å¤¹å†…åˆ›å»ºå­æ–‡ä»¶å¤¹ "å­æ–‡ä»¶å¤¹A"</li>
                <li>éªŒè¯å­æ–‡ä»¶å¤¹æ˜¯å¦åœ¨æ­£ç¡®ä½ç½®</li>
                <li>è¿›å…¥å­æ–‡ä»¶å¤¹A</li>
                <li>åœ¨å­æ–‡ä»¶å¤¹Aå†…åˆ›å»º "æ·±å±‚æ–‡ä»¶å¤¹B"</li>
                <li>éªŒè¯æ·±å±‚æ–‡ä»¶å¤¹æ˜¯å¦åœ¨æ­£ç¡®ä½ç½®</li>
            </ol>
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
        <div id="test-results"></div>
        <div id="folder-structure"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ”§ æ‰‹åŠ¨æµ‹è¯•å·¥å…·</h2>
        <button class="test-button" onclick="openFilesPage()">ğŸ“‚ æ‰“å¼€æ–‡ä»¶ç®¡ç†é¡µé¢</button>
        <button class="test-button" onclick="checkCurrentStructure()">ğŸ” æ£€æŸ¥å½“å‰æ–‡ä»¶å¤¹ç»“æ„</button>
        <button class="test-button" onclick="testCreateInRoot()">ğŸ“ åœ¨æ ¹ç›®å½•åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¤¹</button>
        <div id="manual-test-results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let testFolders = []; // å­˜å‚¨æµ‹è¯•åˆ›å»ºçš„æ–‡ä»¶å¤¹IDï¼Œç”¨äºæ¸…ç†
        
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function appendResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML += `<div class="status ${type}">${message}</div>`;
        }
        
        function openFilesPage() {
            window.open('http://localhost:5173/files', '_blank');
        }
        
        async function getAuthHeaders() {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('è¯·å…ˆç™»å½•ï¼');
            }
            return { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json' };
        }
        
        async function createFolder(name, parentId = null) {
            const headers = await getAuthHeaders();
            const data = { name };
            if (parentId) {
                data.parent = parentId;
            }
            
            const response = await fetch(`${API_BASE}/api/files/folders/`, {
                method: 'POST',
                headers,
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                const folder = await response.json();
                testFolders.push(folder.id);
                return folder;
            } else {
                const error = await response.text();
                throw new Error(`åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: ${response.status} - ${error}`);
            }
        }
        
        async function getFolderContents(folderId = null) {
            const headers = await getAuthHeaders();
            const url = folderId ? `${API_BASE}/api/files/?folder_id=${folderId}` : `${API_BASE}/api/files/`;
            
            const response = await fetch(url, { headers });
            if (response.ok) {
                return await response.json();
            } else {
                throw new Error(`è·å–æ–‡ä»¶å¤¹å†…å®¹å¤±è´¥: ${response.status}`);
            }
        }
        
        async function deleteFolder(folderId) {
            const headers = await getAuthHeaders();
            const response = await fetch(`${API_BASE}/api/files/folders/${folderId}/`, {
                method: 'DELETE',
                headers
            });
            
            if (!response.ok && response.status !== 404) {
                throw new Error(`åˆ é™¤æ–‡ä»¶å¤¹å¤±è´¥: ${response.status}`);
            }
        }
        
        async function runFullTest() {
            showStatus('test-status', 'å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•...', 'info');
            document.getElementById('test-results').innerHTML = '';
            
            try {
                // æ­¥éª¤1: åˆ›å»ºä¸»æµ‹è¯•æ–‡ä»¶å¤¹
                appendResult('test-results', 'æ­¥éª¤1: åˆ›å»ºä¸»æµ‹è¯•æ–‡ä»¶å¤¹...', 'info');
                const mainFolder = await createFolder('ä½ç½®æµ‹è¯•ä¸»æ–‡ä»¶å¤¹');
                appendResult('test-results', `âœ… ä¸»æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸï¼ŒID: ${mainFolder.id}`, 'success');
                
                // æ­¥éª¤2: éªŒè¯ä¸»æ–‡ä»¶å¤¹åœ¨æ ¹ç›®å½•
                appendResult('test-results', 'æ­¥éª¤2: éªŒè¯ä¸»æ–‡ä»¶å¤¹åœ¨æ ¹ç›®å½•...', 'info');
                const rootContents = await getFolderContents();
                const mainFolderInRoot = rootContents.folders.find(f => f.id === mainFolder.id);
                if (mainFolderInRoot) {
                    appendResult('test-results', 'âœ… ä¸»æ–‡ä»¶å¤¹æ­£ç¡®åˆ›å»ºåœ¨æ ¹ç›®å½•', 'success');
                } else {
                    appendResult('test-results', 'âŒ ä¸»æ–‡ä»¶å¤¹æœªåœ¨æ ¹ç›®å½•æ‰¾åˆ°', 'error');
                    return;
                }
                
                // æ­¥éª¤3: åœ¨ä¸»æ–‡ä»¶å¤¹å†…åˆ›å»ºå­æ–‡ä»¶å¤¹
                appendResult('test-results', 'æ­¥éª¤3: åœ¨ä¸»æ–‡ä»¶å¤¹å†…åˆ›å»ºå­æ–‡ä»¶å¤¹...', 'info');
                const subFolderA = await createFolder('å­æ–‡ä»¶å¤¹A', mainFolder.id);
                appendResult('test-results', `âœ… å­æ–‡ä»¶å¤¹Aåˆ›å»ºæˆåŠŸï¼ŒID: ${subFolderA.id}`, 'success');
                
                // æ­¥éª¤4: éªŒè¯å­æ–‡ä»¶å¤¹åœ¨ä¸»æ–‡ä»¶å¤¹å†…
                appendResult('test-results', 'æ­¥éª¤4: éªŒè¯å­æ–‡ä»¶å¤¹åœ¨ä¸»æ–‡ä»¶å¤¹å†…...', 'info');
                const mainFolderContents = await getFolderContents(mainFolder.id);
                const subFolderInMain = mainFolderContents.folders.find(f => f.id === subFolderA.id);
                if (subFolderInMain) {
                    appendResult('test-results', 'âœ… å­æ–‡ä»¶å¤¹Aæ­£ç¡®åˆ›å»ºåœ¨ä¸»æ–‡ä»¶å¤¹å†…', 'success');
                } else {
                    appendResult('test-results', 'âŒ å­æ–‡ä»¶å¤¹Aæœªåœ¨ä¸»æ–‡ä»¶å¤¹å†…æ‰¾åˆ°', 'error');
                    
                    // æ£€æŸ¥æ˜¯å¦é”™è¯¯åˆ›å»ºåœ¨æ ¹ç›®å½•
                    const rootCheck = await getFolderContents();
                    const subFolderInRoot = rootCheck.folders.find(f => f.id === subFolderA.id);
                    if (subFolderInRoot) {
                        appendResult('test-results', 'âŒ å­æ–‡ä»¶å¤¹Aé”™è¯¯åœ°åˆ›å»ºåœ¨äº†æ ¹ç›®å½•ï¼', 'error');
                    }
                    return;
                }
                
                // æ­¥éª¤5: åœ¨å­æ–‡ä»¶å¤¹Aå†…åˆ›å»ºæ·±å±‚æ–‡ä»¶å¤¹
                appendResult('test-results', 'æ­¥éª¤5: åœ¨å­æ–‡ä»¶å¤¹Aå†…åˆ›å»ºæ·±å±‚æ–‡ä»¶å¤¹...', 'info');
                const deepFolderB = await createFolder('æ·±å±‚æ–‡ä»¶å¤¹B', subFolderA.id);
                appendResult('test-results', `âœ… æ·±å±‚æ–‡ä»¶å¤¹Båˆ›å»ºæˆåŠŸï¼ŒID: ${deepFolderB.id}`, 'success');
                
                // æ­¥éª¤6: éªŒè¯æ·±å±‚æ–‡ä»¶å¤¹åœ¨å­æ–‡ä»¶å¤¹Aå†…
                appendResult('test-results', 'æ­¥éª¤6: éªŒè¯æ·±å±‚æ–‡ä»¶å¤¹åœ¨å­æ–‡ä»¶å¤¹Aå†…...', 'info');
                const subFolderAContents = await getFolderContents(subFolderA.id);
                const deepFolderInSub = subFolderAContents.folders.find(f => f.id === deepFolderB.id);
                if (deepFolderInSub) {
                    appendResult('test-results', 'âœ… æ·±å±‚æ–‡ä»¶å¤¹Bæ­£ç¡®åˆ›å»ºåœ¨å­æ–‡ä»¶å¤¹Aå†…', 'success');
                } else {
                    appendResult('test-results', 'âŒ æ·±å±‚æ–‡ä»¶å¤¹Bæœªåœ¨å­æ–‡ä»¶å¤¹Aå†…æ‰¾åˆ°', 'error');
                    return;
                }
                
                // æ˜¾ç¤ºæ–‡ä»¶å¤¹ç»“æ„
                await showFolderStructure();
                
                appendResult('test-results', 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ–‡ä»¶å¤¹åˆ›å»ºä½ç½®åŠŸèƒ½æ­£å¸¸å·¥ä½œ', 'success');
                showStatus('test-status', 'æµ‹è¯•å®Œæˆï¼æ‰€æœ‰åŠŸèƒ½æ­£å¸¸', 'success');
                
            } catch (error) {
                appendResult('test-results', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showStatus('test-status', `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function showFolderStructure() {
            try {
                const rootContents = await getFolderContents();
                let structure = 'æ–‡ä»¶å¤¹ç»“æ„:\\n';
                structure += 'ğŸ“ æ ¹ç›®å½•\\n';
                
                for (const folder of rootContents.folders) {
                    if (folder.name.includes('ä½ç½®æµ‹è¯•')) {
                        structure += `  ğŸ“ ${folder.name} (ID: ${folder.id})\\n`;
                        
                        // è·å–å­æ–‡ä»¶å¤¹
                        const subContents = await getFolderContents(folder.id);
                        for (const subFolder of subContents.folders) {
                            structure += `    ğŸ“ ${subFolder.name} (ID: ${subFolder.id})\\n`;
                            
                            // è·å–æ·±å±‚æ–‡ä»¶å¤¹
                            const deepContents = await getFolderContents(subFolder.id);
                            for (const deepFolder of deepContents.folders) {
                                structure += `      ğŸ“ ${deepFolder.name} (ID: ${deepFolder.id})\\n`;
                            }
                        }
                    }
                }
                
                document.getElementById('folder-structure').innerHTML = 
                    `<h3>ğŸ“Š å½“å‰æ–‡ä»¶å¤¹ç»“æ„</h3><div class="folder-tree">${structure}</div>`;
                    
            } catch (error) {
                document.getElementById('folder-structure').innerHTML = 
                    `<div class="status error">è·å–æ–‡ä»¶å¤¹ç»“æ„å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        async function clearTestData() {
            showStatus('test-status', 'æ¸…ç†æµ‹è¯•æ•°æ®...', 'info');
            
            try {
                // æŒ‰åˆ›å»ºé¡ºåºçš„é€†åºåˆ é™¤ï¼ˆå…ˆåˆ é™¤å­æ–‡ä»¶å¤¹ï¼‰
                for (let i = testFolders.length - 1; i >= 0; i--) {
                    try {
                        await deleteFolder(testFolders[i]);
                    } catch (error) {
                        console.warn(`åˆ é™¤æ–‡ä»¶å¤¹ ${testFolders[i]} å¤±è´¥:`, error);
                    }
                }
                
                testFolders = [];
                document.getElementById('test-results').innerHTML = '';
                document.getElementById('folder-structure').innerHTML = '';
                showStatus('test-status', 'æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ', 'success');
                
            } catch (error) {
                showStatus('test-status', `æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function checkCurrentStructure() {
            showStatus('manual-test-results', 'æ£€æŸ¥å½“å‰æ–‡ä»¶å¤¹ç»“æ„...', 'info');
            await showFolderStructure();
        }
        
        async function testCreateInRoot() {
            try {
                const folder = await createFolder('æ‰‹åŠ¨æµ‹è¯•æ–‡ä»¶å¤¹_' + Date.now());
                showStatus('manual-test-results', `åœ¨æ ¹ç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹æˆåŠŸï¼ŒID: ${folder.id}`, 'success');
            } catch (error) {
                showStatus('manual-test-results', `åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            const token = localStorage.getItem('token');
            if (!token) {
                showStatus('test-status', 'è¯·å…ˆç™»å½•åå†è¿›è¡Œæµ‹è¯•', 'error');
            } else {
                showStatus('test-status', 'å·²ç™»å½•ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'success');
            }
        };
    </script>
</body>
</html>