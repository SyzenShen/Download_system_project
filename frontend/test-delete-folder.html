<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶å¤¹åˆ é™¤åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .test-button.danger:hover {
            background: #c82333;
        }
        .test-button.success {
            background: #28a745;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .folder-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .folder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .folder-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .folder-actions {
            display: flex;
            gap: 5px;
        }
        .api-result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .test-scenario {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin: 10px 0;
            padding: 15px;
        }
        .test-scenario h4 {
            margin-top: 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <h1>ğŸ—‘ï¸ æ–‡ä»¶å¤¹åˆ é™¤åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ¯ æµ‹è¯•ç›®æ ‡</h2>
        <p>æµ‹è¯•å’Œè°ƒè¯•æ–‡ä»¶å¤¹åˆ é™¤åŠŸèƒ½ï¼Œè¯†åˆ«åˆ é™¤å¤±è´¥çš„åŸå› å¹¶æä¾›è§£å†³æ–¹æ¡ˆã€‚</p>
        
        <div class="status info">
            <strong>å¸¸è§åˆ é™¤å¤±è´¥åŸå› ï¼š</strong>
            <ul>
                <li>æ–‡ä»¶å¤¹ä¸ä¸ºç©ºï¼ˆåŒ…å«å­æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶ï¼‰</li>
                <li>æƒé™ä¸è¶³</li>
                <li>æ–‡ä»¶å¤¹ä¸å­˜åœ¨</li>
                <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
            </ul>
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“‹ å½“å‰æ–‡ä»¶å¤¹åˆ—è¡¨</h2>
        <button class="test-button" onclick="loadFolders()">ğŸ”„ åˆ·æ–°æ–‡ä»¶å¤¹åˆ—è¡¨</button>
        <div id="folder-list"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ§ª åˆ é™¤æµ‹è¯•åœºæ™¯</h2>
        
        <div class="test-scenario">
            <h4>åœºæ™¯1: åˆ é™¤ç©ºæ–‡ä»¶å¤¹</h4>
            <button class="test-button" onclick="createEmptyFolder()">ğŸ“ åˆ›å»ºç©ºæ–‡ä»¶å¤¹</button>
            <button class="test-button danger" onclick="deleteLastCreatedFolder()">ğŸ—‘ï¸ åˆ é™¤æœ€ååˆ›å»ºçš„æ–‡ä»¶å¤¹</button>
            <div id="empty-folder-result"></div>
        </div>
        
        <div class="test-scenario">
            <h4>åœºæ™¯2: åˆ é™¤éç©ºæ–‡ä»¶å¤¹</h4>
            <button class="test-button" onclick="createFolderWithContent()">ğŸ“ åˆ›å»ºåŒ…å«å†…å®¹çš„æ–‡ä»¶å¤¹</button>
            <button class="test-button danger" onclick="deleteNonEmptyFolder()">ğŸ—‘ï¸ å°è¯•åˆ é™¤éç©ºæ–‡ä»¶å¤¹</button>
            <div id="non-empty-folder-result"></div>
        </div>
        
        <div class="test-scenario">
            <h4>åœºæ™¯3: åˆ é™¤ä¸å­˜åœ¨çš„æ–‡ä»¶å¤¹</h4>
            <button class="test-button danger" onclick="deleteNonExistentFolder()">ğŸ—‘ï¸ å°è¯•åˆ é™¤ä¸å­˜åœ¨çš„æ–‡ä»¶å¤¹</button>
            <div id="non-existent-folder-result"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ”§ æ‰‹åŠ¨æµ‹è¯•å·¥å…·</h2>
        <input type="text" id="folder-id-input" placeholder="è¾“å…¥æ–‡ä»¶å¤¹ID" style="padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px;">
        <button class="test-button danger" onclick="deleteSpecificFolder()">ğŸ—‘ï¸ åˆ é™¤æŒ‡å®šæ–‡ä»¶å¤¹</button>
        <button class="test-button" onclick="openFilesPage()">ğŸ“‚ æ‰“å¼€æ–‡ä»¶ç®¡ç†é¡µé¢</button>
        <div id="manual-test-result"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š æµ‹è¯•ç»“æœå’Œé”™è¯¯æ—¥å¿—</h2>
        <button class="test-button" onclick="clearLogs()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
        <div id="test-logs"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let testFolders = []; // å­˜å‚¨æµ‹è¯•åˆ›å»ºçš„æ–‡ä»¶å¤¹
        let allFolders = []; // å­˜å‚¨æ‰€æœ‰æ–‡ä»¶å¤¹
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('test-logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `<div class="status ${type}">[${timestamp}] ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function clearLogs() {
            document.getElementById('test-logs').innerHTML = '';
        }
        
        function openFilesPage() {
            window.open('http://localhost:5173/files', '_blank');
        }
        
        async function getAuthHeaders() {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('è¯·å…ˆç™»å½•ï¼è¯·åœ¨æ–‡ä»¶ç®¡ç†é¡µé¢ç™»å½•åå†è¿›è¡Œæµ‹è¯•ã€‚');
            }
            return { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json' };
        }
        
        async function createFolder(name, parentId = null) {
            try {
                const headers = await getAuthHeaders();
                const data = { name };
                if (parentId) {
                    data.parent = parentId;
                }
                
                const response = await fetch(`${API_BASE}/api/files/folders/`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const folder = await response.json();
                    testFolders.push(folder);
                    log(`âœ… æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ: ${folder.name} (ID: ${folder.id})`, 'success');
                    return folder;
                } else {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { error: errorText };
                    }
                    throw new Error(`åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥ (${response.status}): ${errorData.error || errorData.message || errorText}`);
                }
            } catch (error) {
                log(`âŒ åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }
        
        async function deleteFolder(folderId) {
            try {
                const headers = await getAuthHeaders();
                
                log(`ğŸ—‘ï¸ å°è¯•åˆ é™¤æ–‡ä»¶å¤¹ ID: ${folderId}`, 'info');
                
                const response = await fetch(`${API_BASE}/api/files/folders/${folderId}/`, {
                    method: 'DELETE',
                    headers
                });
                
                if (response.ok || response.status === 204) {
                    log(`âœ… æ–‡ä»¶å¤¹åˆ é™¤æˆåŠŸ ID: ${folderId}`, 'success');
                    return { success: true, message: 'æ–‡ä»¶å¤¹åˆ é™¤æˆåŠŸ' };
                } else {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { error: errorText };
                    }
                    
                    const errorMessage = errorData.error || errorData.message || errorData.detail || errorText;
                    log(`âŒ æ–‡ä»¶å¤¹åˆ é™¤å¤±è´¥ (${response.status}): ${errorMessage}`, 'error');
                    
                    return { 
                        success: false, 
                        error: errorMessage,
                        status: response.status,
                        details: errorData
                    };
                }
            } catch (error) {
                log(`âŒ åˆ é™¤æ–‡ä»¶å¤¹æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }
        
        async function getFolders() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`${API_BASE}/api/files/`, { headers });
                
                if (response.ok) {
                    const data = await response.json();
                    allFolders = data.folders || [];
                    return allFolders;
                } else {
                    throw new Error(`è·å–æ–‡ä»¶å¤¹åˆ—è¡¨å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                log(`âŒ è·å–æ–‡ä»¶å¤¹åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
                return [];
            }
        }
        
        async function getFolderContents(folderId) {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`${API_BASE}/api/files/?folder_id=${folderId}`, { headers });
                
                if (response.ok) {
                    return await response.json();
                } else {
                    throw new Error(`è·å–æ–‡ä»¶å¤¹å†…å®¹å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                log(`âŒ è·å–æ–‡ä»¶å¤¹å†…å®¹å¤±è´¥: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function loadFolders() {
            log('ğŸ”„ æ­£åœ¨åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨...', 'info');
            const folders = await getFolders();
            
            const folderListDiv = document.getElementById('folder-list');
            if (folders.length === 0) {
                folderListDiv.innerHTML = '<div class="status info">æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶å¤¹</div>';
                return;
            }
            
            let html = '<div class="folder-list">';
            for (const folder of folders) {
                // æ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦ä¸ºç©º
                const contents = await getFolderContents(folder.id);
                const isEmpty = contents && contents.folders.length === 0 && contents.files.length === 0;
                const statusText = isEmpty ? '(ç©º)' : '(éç©º)';
                const statusClass = isEmpty ? 'success' : 'warning';
                
                html += `
                    <div class="folder-item">
                        <div class="folder-info">
                            <span>ğŸ“</span>
                            <span><strong>${folder.name}</strong> (ID: ${folder.id})</span>
                            <span class="status ${statusClass}" style="padding: 2px 6px; font-size: 12px;">${statusText}</span>
                        </div>
                        <div class="folder-actions">
                            <button class="test-button danger" onclick="testDeleteFolder(${folder.id}, '${folder.name}')">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            folderListDiv.innerHTML = html;
            
            log(`ğŸ“‹ åŠ è½½äº† ${folders.length} ä¸ªæ–‡ä»¶å¤¹`, 'success');
        }
        
        async function testDeleteFolder(folderId, folderName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ "${folderName}" (ID: ${folderId}) å—ï¼Ÿ`)) {
                return;
            }
            
            const result = await deleteFolder(folderId);
            if (result.success) {
                await loadFolders(); // åˆ·æ–°åˆ—è¡¨
            } else {
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                const errorDetails = result.details ? JSON.stringify(result.details, null, 2) : '';
                log(`åˆ é™¤å¤±è´¥è¯¦æƒ…:\nçŠ¶æ€ç : ${result.status}\né”™è¯¯ä¿¡æ¯: ${result.error}\n${errorDetails}`, 'error');
            }
        }
        
        async function createEmptyFolder() {
            try {
                const folderName = `ç©ºæ–‡ä»¶å¤¹_${Date.now()}`;
                await createFolder(folderName);
                await loadFolders();
                showResult('empty-folder-result', 'âœ… ç©ºæ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ', 'success');
            } catch (error) {
                showResult('empty-folder-result', `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testDeleteEmptyFolder() {
            log('ğŸ—‘ï¸ å¼€å§‹æµ‹è¯•åˆ é™¤ç©ºæ–‡ä»¶å¤¹...');
            
            // é¦–å…ˆåˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶å¤¹
            const createResult = await createFolder('æµ‹è¯•ç©ºæ–‡ä»¶å¤¹_' + Date.now());
            if (!createResult.success) {
                log('âŒ åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¤¹å¤±è´¥: ' + createResult.error, 'error');
                return;
            }
            
            const folderId = createResult.data.id;
            log('ğŸ“ åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¤¹æˆåŠŸï¼ŒID: ' + folderId);
            
            // åˆ é™¤ç©ºæ–‡ä»¶å¤¹
            const deleteResult = await deleteFolder(folderId);
            if (deleteResult.success) {
                log('âœ… åˆ é™¤ç©ºæ–‡ä»¶å¤¹æˆåŠŸ', 'success');
            } else {
                log('âŒ åˆ é™¤ç©ºæ–‡ä»¶å¤¹å¤±è´¥: ' + deleteResult.error, 'error');
            }
        }
        
        async function deleteLastCreatedFolder() {
            if (testFolders.length === 0) {
                showResult('empty-folder-result', 'âŒ æ²¡æœ‰å¯åˆ é™¤çš„æµ‹è¯•æ–‡ä»¶å¤¹', 'error');
                return;
            }
            
            const lastFolder = testFolders[testFolders.length - 1];
            const result = await deleteFolder(lastFolder.id);
            
            if (result.success) {
                testFolders.pop();
                await loadFolders();
                showResult('empty-folder-result', 'âœ… ç©ºæ–‡ä»¶å¤¹åˆ é™¤æˆåŠŸ', 'success');
            } else {
                showResult('empty-folder-result', `âŒ åˆ é™¤å¤±è´¥: ${result.error}`, 'error');
            }
        }
        
        async function createFolderWithContent() {
            try {
                const parentFolderName = `éç©ºæ–‡ä»¶å¤¹_${Date.now()}`;
                const parentFolder = await createFolder(parentFolderName);
                
                // åœ¨çˆ¶æ–‡ä»¶å¤¹ä¸­åˆ›å»ºå­æ–‡ä»¶å¤¹
                const subFolderName = `å­æ–‡ä»¶å¤¹_${Date.now()}`;
                await createFolder(subFolderName, parentFolder.id);
                
                await loadFolders();
                showResult('non-empty-folder-result', 'âœ… åŒ…å«å†…å®¹çš„æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ', 'success');
            } catch (error) {
                showResult('non-empty-folder-result', `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function deleteNonEmptyFolder() {
            // æ‰¾åˆ°æœ€åä¸€ä¸ªéç©ºçš„æµ‹è¯•æ–‡ä»¶å¤¹
            let nonEmptyFolder = null;
            for (let i = testFolders.length - 1; i >= 0; i--) {
                const contents = await getFolderContents(testFolders[i].id);
                if (contents && (contents.folders.length > 0 || contents.files.length > 0)) {
                    nonEmptyFolder = testFolders[i];
                    break;
                }
            }
            
            if (!nonEmptyFolder) {
                showResult('non-empty-folder-result', 'âŒ æ²¡æœ‰æ‰¾åˆ°éç©ºçš„æµ‹è¯•æ–‡ä»¶å¤¹', 'error');
                return;
            }
            
            const result = await deleteFolder(nonEmptyFolder.id);
            
            if (result.success) {
                await loadFolders();
                showResult('non-empty-folder-result', 'âš ï¸ éç©ºæ–‡ä»¶å¤¹ç«Ÿç„¶åˆ é™¤æˆåŠŸäº†ï¼è¿™å¯èƒ½æ˜¯ä¸ªé—®é¢˜', 'warning');
            } else {
                showResult('non-empty-folder-result', `âœ… æ­£ç¡®è¡Œä¸º: éç©ºæ–‡ä»¶å¤¹åˆ é™¤è¢«æ‹’ç» - ${result.error}`, 'success');
            }
        }
        
        async function deleteNonExistentFolder() {
            const fakeId = 99999;
            const result = await deleteFolder(fakeId);
            
            if (result.success) {
                showResult('non-existent-folder-result', 'âš ï¸ åˆ é™¤ä¸å­˜åœ¨çš„æ–‡ä»¶å¤¹ç«Ÿç„¶è¿”å›æˆåŠŸï¼', 'warning');
            } else {
                showResult('non-existent-folder-result', `âœ… æ­£ç¡®è¡Œä¸º: åˆ é™¤ä¸å­˜åœ¨çš„æ–‡ä»¶å¤¹è¢«æ‹’ç» - ${result.error}`, 'success');
            }
        }
        
        async function deleteSpecificFolder() {
            const folderId = document.getElementById('folder-id-input').value.trim();
            if (!folderId) {
                showResult('manual-test-result', 'âŒ è¯·è¾“å…¥æ–‡ä»¶å¤¹ID', 'error');
                return;
            }
            
            const result = await deleteFolder(parseInt(folderId));
            
            if (result.success) {
                await loadFolders();
                showResult('manual-test-result', 'âœ… æ–‡ä»¶å¤¹åˆ é™¤æˆåŠŸ', 'success');
            } else {
                showResult('manual-test-result', `âŒ åˆ é™¤å¤±è´¥: ${result.error}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶åŠ è½½æ–‡ä»¶å¤¹
        window.onload = async function() {
            const token = localStorage.getItem('token');
            if (!token) {
                log('âš ï¸ æœªç™»å½•ï¼Œè¯·å…ˆåœ¨æ–‡ä»¶ç®¡ç†é¡µé¢ç™»å½•', 'warning');
                return;
            }
            
            log('âœ… å·²ç™»å½•ï¼Œå¼€å§‹åŠ è½½æ–‡ä»¶å¤¹åˆ—è¡¨', 'success');
            await loadFolders();
        };
    </script>
</body>
</html>