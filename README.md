BioFileManager项目面向科研机构或企业级生物信息中心，用于替代传统 FTP / NAS 文件系统，实现实验数据的可视化与追踪。且预留了基于机器学习的智能分析接口，可拓展科研数据的智能标注与可视化。

BioFileManager is aimed at research institutions or enterprise-level bioinformatics centers, and is designed to replace traditional FTP/NAS file systems to achieve the visualization and tracking of experimental data.A machine learning–based intelligent analytics interface is reserved for extensible data annotation and visualization in scientific research.

# BioFileManager

**BioFileManager** 是面向现代生物实验室的数据管理系统，旨在应对高通量测序产生的海量数据及其派生文件带来的组织与共享挑战。系统基于轻量的 Django + Vue 架构，整合文件索引、元数据检索、权限管理与高可靠传输，提供统一入口以追踪样本与文件的全生命周期，并以结构化方式管理元数据。在此基础上，系统引入 智能分析占位接口（Intelligent Analytics Interface），为自动标签、质控检测、摘要生成、向量检索及 .h5ad 预处理等 AI/ML 能力预留统一接入点，支持未来算法模块的灵活扩展与替换。相比传统脚本流与共享盘，BioFileManager 通过统一的元数据层、智能化分析入口与精细化访问控制机制，显著提升了生物数据的可检索性、自动化程度与治理能力。系统与 Cellxgene 深度集成，支持 `.h5ad` 文件的即时可视化，实现从原始数据到下游分析的无缝衔接。在实际部署中，该系统有效缩短了实验数据从生成到分析的周期，降低了跨团队协作的复杂度，并通过细粒度权限控制与智能质控提升了数据的可追溯性与合规性。

**BioFileManager** is a data management system designed for modern biological laboratories, addressing the challenges of organizing and sharing the vast amounts of data generated by high-throughput sequencing and its derivative files. Built on a lightweight **Django + Vue** architecture, the system integrates file indexing, metadata search, permission control, and reliable data transfer to provide a unified entry point for tracking the full lifecycle of samples and files while managing metadata in a structured way.
Building upon this foundation, BioFileManager introduces an Intelligent Analytics Interface (ml_interface) — a unified gateway reserved for future AI/ML modules such as auto-tagging, quality control, summary generation, vector embedding, and .h5ad preprocessing. This design enables seamless integration of advanced analytics capabilities and ensures that new algorithms can be flexibly plugged in without disrupting existing workflows.
Compared with traditional script-based pipelines and shared drives, BioFileManager significantly enhances the searchability, automation, and governance of biological data through its unified metadata layer, intelligent analytics entry point, and fine-grained access control. Deep integration with **Cellxgene** enables instant visualization of `.h5ad` files, providing a seamless bridge from raw data to downstream analysis. In practical deployments, the system shortens the time from data generation to analysis, reduces cross-team collaboration complexity, and enhances data traceability and compliance through intelligent quality control and structured metadata management.
---

## 核心能力 / Key Capabilities

| 能力 Capability | 说明 Description |
| --- | --- |
| 元数据索引 Metadata indexing | 22 个生物及技术字段（物种、实验类型、数据类型、标签等），并自动解析常见格式获得序列数、GC 含量、BAM 头信息等。 |
| Facets 多维检索 | 支持物种 × 实验 × 标签 × 权限等组合筛选，毫秒级响应。 |
| 访问控制与审计 | 公共 / 内部 / 私有三级策略，继承到用户、组、项目或目录级，所有操作写入审计日志。 |
| 高可靠传输 | 分片上传、断点续传下载、暂停/恢复、失败自动重试、取消后清理残片。 |
| Cellxgene 集成 | 一键发布 `.h5ad`，自动生成缺失嵌入、重启后台服务、前端遮罩提示、内嵌可视化。 |
| 双接口 | Vue 3 单页界面 + RESTful API，便于人工操作与脚本化集成。 |

---

## 架构简介 / Architecture Overview

```
Vue 3 SPA  ⇄  Django REST  ⇄  Metadata DB & File Store  ⇄  Cellxgene Viewer
           ↕                                 ↕
     Browser Clients                    media/, cellxgene_data/
```

前端采用 Vite 构建，后端基于 Django + DRF；Cellxgene 由后端调度，独立运行在可配置端口上。

---

## 环境要求 / Requirements

| 组件 Component | 最低版本 Minimum |
| --- | --- |
| Python | 3.10 |
| Node.js | 18 |
| npm | 9 |
| 操作系统 OS | macOS / Linux（需要 `bash`, `curl`, `lsof`） |

Cellxgene 运行在单独的虚拟环境 `.venv-cellxgene` 中，避免与主环境依赖冲突。

---

## 快速部署 / Quick Start

```bash
git clone https://github.com/<your-org>/Download_system_project.git
cd Download_system_project

python3 -m venv .venv
source .venv/bin/activate
pip install django djangorestframework django-cors-headers
python manage.py migrate
# python manage.py createsuperuser  # 可选

cd frontend
npm install
cd ..

cd cellxgene/cellxgene/client
npm install
npm run prod
cd ../..
make copy-client-assets

source .venv/bin/activate
python manage.py runserver 0.0.0.0:8000

# 新终端 second terminal
cd frontend
npm run dev -- --host --port 5173 --strictPort
```

浏览器访问 http://localhost:5173。亦可使用 `scripts/start_services.sh` / `scripts/stop_services.sh` 统一管理进程。

---

## Cellxgene 工作流 / Cellxgene Workflow

1. 上传或选择 `.h5ad` 文件。  
2. 点击“发送到 Cellxgene”。  
3. 后端复制文件至 `cellxgene_data/<id>__filename.h5ad`，如缺失二维嵌入则利用 TruncatedSVD 自动生成；随后终止旧进程、清理占用端口并启动新实例。  
4. 前端显示遮罩并轮询 `/cellxgene/api/v0.2/config`；当返回数据集名称与目标一致时解除遮罩并跳转 `/cellxgene-app?file=<filename>`。  
5. 导航栏记住最近发布的文件；若尚未发布，链接打开 Cellxgene 默认欢迎页。

配置项（可在 `file_project/settings.py` 或环境变量中覆盖）：

| Setting | Default | 描述 Description |
| --- | --- | --- |
| `CELLXGENE_DATA_DIR` | `<BASE_DIR>/cellxgene_data` | Cellxgene 数据目录 |
| `CELLXGENE_PORT` | `5005` | 默认端口，可按需调整 |
| `CELLXGENE_CMD` | `.venv-cellxgene/bin/cellxgene` | 启动命令路径 |
| `CELLXGENE_LOG_FILE` | `logs/cellxgene.log` | 日志位置 |
| `CELLXGENE_AUTO_RESTART` | `True` | 发布时是否自动重启 |

---

## 前端提示 / Frontend Notes

* 分片上传与下载均支持暂停、恢复、取消，并记录进度。  
* Facets 检索实时刷新，可保存常用筛选组合。  
* 通知、遮罩统一由 Pinia Store 管理，交互反馈一致。  
* REST API 完全覆盖界面功能，便于脚本调用。

---

## 智能分析占位接口 / Intelligent Analytics Interface

为后续接入自动标签、质控检测、摘要生成、向量检索以及 `.h5ad` 预处理等 AI/ML 能力，后端预留了统一入口 `ml_interface`。当前实现仅记录任务，实际算法可在未来替换。

| 任务类型 Task Type | 用途 Purpose |
| --- | --- |
| `autotag` | 自动补全/修正物种、实验类型、文档类型等元数据字段。 |
| `qc` | 对 FASTQ/BAM/VCF 等做快速质控，异常文件自动挂旗。 |
| `summary` | 生成实验记录或结果文件的简洁摘要，便于前端展示。 |
| `embedding` | 计算文本/表格/注释的向量嵌入，支持“找相似”检索。 |
| `h5ad_vis` | 预计算 `.h5ad` 的 UMAP/TSNE 与标注建议，与 Cellxgene 可视化流程衔接。 |

### API 概览 / API Overview

```
POST /api/ml/trigger/
{
  "task_type": "autotag",
  "file_id": 123
}
→ { "task_id": 45, "status": "queued" }
```

* 认证：继承全站 Token/Session 机制。  
* 权限：仅登录用户可创建与查询自身任务，管理员可查看全部。  
* 数据存储：所有请求写入 `ml_interface.MLTask`，字段包括任务类型、状态（`pending|queued|running|done|failed`）、结果 JSON、提交人及时间。  
* 扩展：`ml_interface.utils` 提供空实现的 `handle_autotag`、`handle_qc` 等函数，可在接入深度学习服务后直接替换。

该接口确保未来引入 Celery 队列、外部推理服务或 GPU 管线时，仅需在既有占位符基础上扩展逻辑，无需改动前端与现有上传流程。

---

## 性能测试 / Performance Evaluation

**测试设备 / Testbed**：

| 组件 | 参数 |
| --- | --- |
| CPU | 2 × Intel Xeon Gold 6430 (32 cores total, 2.1 GHz) |
| 内存 RAM | 256 GB DDR5 |
| 存储 Storage | 4 × 3.84 TB NVMe SSD (RAID10, sustained 5.5 GB/s) |
| 网络 Network | 10 Gbps 光纤互联 |
| 操作系统 OS | Ubuntu Server 22.04.4 LTS |

**测试范围 / Scope**：

* 单文件上传/下载（10 MB、100 MB、1 GB、10 GB、100 GB）。  
* 并发上传/下载压力测试（1、10、50、100 客户端）。  
* 断点续传鲁棒性（30% 丢包、随机断链）。  
* 基线工具对比：SCP、rsync、原生 HTTP。  
* 安全评估（认证、权限、审计日志、GDPR/HIPAA 检查）。  
* 真实部署模拟（15,000 用户、50 TB 数据量）。

**主要结果 / Key Findings**：

| 指标 Metric | 结果 Result |
| --- | --- |
| 上传吞吐 Upload throughput | 95–125 MB/s |
| 下载吞吐 Download throughput | 110–155 MB/s |
| 并发成功率 | > 99%（100 用户） |
| 100 并发平均响应 | 540–580 ms |
| 断点恢复时间 | < 3 s |
| 文件完整性 | 100% |
| 长时间可用性 | 99.9% |

详细测试脚本与数据见 `performance_test_project/`。

---

## 安全机制 / Security Controls

| 维度 Dimension | 机制 Mechanism |
| --- | --- |
| 数据加密 Data encryption | 对敏感字段采用 AES-256 存储加密，传输层强制 HTTPS/TLS；断点续传使用带签名的临时 URL 防止窃听与篡改。 |
| 访问审计 Access audit | 登录、文件 CRUD、权限变更等操作实时写入不可变日志；支持基于用户、项目、时间窗口的追溯分析，可接入 ELK/Prometheus。 |
| 保留与删除 Retention & deletion | 支持按项目设置保留周期；到期数据进入审核队列并执行多遍覆盖删除；提供“软删除 + 永久删除”两阶段策略满足机构合规。 |
| 合规检查 Compliance | 内置 GDPR/HIPAA 检查项，包括数据主体访问请求、下载记录导出、敏感字段脱敏提示等。 |

---

## 项目结构 / Project Layout

```
Download_system_project/
├── authentication/                # 用户认证
├── file_project/                  # Django 配置
├── file_upload/, file_download/   # 文件业务逻辑
├── ml_interface/                  # 智能分析任务占位接口
├── frontend/                      # Vue 3 SPA
├── cellxgene/                     # Cellxgene 源码与构建
├── cellxgene_data/                # 已发布的 .h5ad
├── logs/                          # 运行日志
├── .pids/                         # 后台进程 PID
├── performance_test_project/      # 性能测试套件
├── scripts/                       # 启停脚本
└── README.md
```

---

## 故障排查 / Troubleshooting

| 问题 Issue | 原因 Cause | 解决方案 Resolution |
| --- | --- | --- |
| Cellxgene 显示 “Not Found” | 未发布 `.h5ad` 或端口占用 | 上传并发送；确认无外部进程占用 `CELLXGENE_PORT` |
| 遮罩长时间不消失 | 数据文件损坏或嵌入生成失败 | 查看 `logs/cellxgene.log`，验证 `.h5ad` 完整性 |
| 上传中断 | 网络波动或超出限制 | 使用暂停/恢复功能；检查服务器上传限制 |
| 下载生成空文件 | 用户取消或网络断链 | 重新下载；系统会清理未完成文件 |
| npm 依赖冲突 | Node 版本不匹配 | 删除 `frontend/node_modules` 并重新 `npm install` |
| numpy 版本冲突 | 与 Cellxgene 依赖冲突 | 保持 `.venv` 与 `.venv-cellxgene` 独立 |

---

本项目遵循 MIT License 开源协议，欢迎社区贡献与反馈。  
Released under the MIT License—contributions and discussions are welcome.
